
<!DOCTYPE html>
<html lang="en">

<head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge" />

        <title>Muhammad Azeez - Running ASP.NET Core on Linux Part 1</title>
        <meta name="description" content="A blog about software engineering and beyond!" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link type="application/rss+xml" rel="alternate" title="Muhammad Azeez"
                href="/feed.rss" />
                <link type="application/atom+xml" rel="alternate" title="Muhammad Azeez"
                href="/feed.atom" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">

        <link href="/assets/css/bootstrap.min.css" rel="stylesheet" />
        <link href="/assets/css/highlight.css" rel="stylesheet">
        <link href="/assets/css/clean-blog.css" rel="stylesheet" />
        <link href="/assets/css/master.css" rel="stylesheet" />
        <link href="/assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet'
                type='text/css'>
        <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800'
                rel='stylesheet' type='text/css'>
        <link href="/assets/css/override.css" rel="stylesheet" />


        <meta name="application-name" content="Muhammad Azeez" />
        <meta name="msapplication-tooltip" content="Muhammad Azeez" />
        <meta name="msapplication-starturl" content="/" />

        <meta property="og:title" content="Muhammad Azeez - Running ASP.NET Core on Linux Part 1" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://mazeez.dev/posts/aspnet-on-linux-1" />
        <!-- TODO: More social graph meta tags -->

        <script src="/assets/js/jquery.min.js"> </script> <script
                src="/assets/js/bootstrap.min.js"> </script> <script
                src="/assets/js/highlight.pack.js"> </script> <script
                src="/assets/js/clean-blog.js"> </script> <script
                src="/assets/js/d3.v3.min.js"> </script> <script
                src="/assets/js/trianglify.min.js"> </script> <script
                src="/assets/js/Please-compressed.js"> </script> <script
                src="/assets/js/background-check.min.js"> </script> <!-- HTML5 Shim and Respond.js
                IE8 support of HTML5 elements and media queries -->
                <!-- WARNING: Respond.js doesn't work if you view the page via file:// 
                -->
        <!--[if lt IE 9]>
                <script src="/assets/js/html5shiv.js"></script>
                <script src="/assets/js/respond.min.js"></script>
        <![endif]-->

        


</head>

<body>

        <!-- Navigation -->
        <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
                <div class="container-fluid">
                        <!-- Brand and toggle get grouped for better mobile display -->
                        <div class="navbar-header page-scroll">
                                <button type="button" class="navbar-toggle" data-toggle="collapse"
                                        data-target="#navbar-collapse">
                                        <span class="sr-only">Toggle navigation</span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                </button>
                                <a class="navbar-brand" href="/">Muhammad Azeez
                                        </a> </div> <!-- Collect the nav links, forms, and other content for toggling
                                        -->
                                        <div class="collapse navbar-collapse" id="navbar-collapse">
                                                <ul class="nav navbar-nav navbar-right">
                                                                <li><a href="/posts">Archive</a></li>
        <li><a href="/tags">Tags</a></li>
        <li><a href="/about">About Me</a></li>
        <li><a href="/projects">Projects</a></li>

                                                </ul>
                                        </div>
                                        <!-- /.navbar-collapse -->
                        </div>
                        <!-- /.container -->
        </nav>

        <!-- Page Header -->
        <header class="intro-header" id="intro-header" style="background-image: url(&quot;/assets/images/cover.jpg&quot;)">
                <div class="container">
                        <div class="row">
                                <div class="col-md-12">

    
<div class="post-heading">
    <h1>Running ASP.NET Core on Linux Part 1</h1>
    <div class="meta">        
Published on Tuesday, April 7, 2020<br>    </div>
        <div class="tags">
                    <a role="button" href="/tags/aspnet" class="btn btn-default btn-xs">aspnet</a>
                    <a role="button" href="/tags/linux" class="btn btn-default btn-xs">linux</a>
        </div>     
</div>
                                </div>
                        </div>
                </div>
        </header>

        <!-- Main Content -->
        <div class="container">
                <div class="row">
                        <div id="content" class="col-md-12">
                                

<p>In the last couple of weeks, I have been busy setting up a CI/CD pipeline for one of my side projects and getting it to run on Linux. I'll try to write about what I have learned in the process.</p>
<p>This will be a series of blog posts because I don't want it to become too long. This is the first part. We will create a new ASP.NET Core application and manually run it on Linux and configure Nginx and systemd.</p>
<hr />
<p>Before anything lets create a new ASP.NET Core Razor Pages web application by running:</p>
<pre><code>dotnet new webapp
</code></pre>
<p>Good, now add it to a git repository and upload it to GitHub, it will be useful for us in the next part of the series.</p>
<h2 id="setting-up-vscode">Setting up VSCode</h2>
<p>VSCode is great for accessing remote Linux servers. It allows you to open multiple terminals and edit files and allows you to download and upload them too. Follow these steps to set it up:</p>
<ol>
<li><p>Install the <a href="https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-ssh">Remote - SSH</a> extension to be able to login into the server and be able to run commands and edit files.</p>
</li>
<li><p>In <em>Remote Explorer</em> tab add a new SSH Target for your server and inter username and IP address and follow the instructions. After you added the server to <em>Remote Explorer</em> connect to it and in <em>Explorer</em> tab open the <code>/</code> directory.</p>
</li>
<li><p>Download and install the ASP.NET Core runtime on the server. You can find instructions <a href="https://dotnet.microsoft.com/download/dotnet-core">here</a>.</p>
</li>
</ol>
<h2 id="publishing-the-website">Publishing the website</h2>
<p>Before doing anything we have to publish the website first. We will automate this process later but for now, we will do it manually.</p>
<pre><code>dotnet publish -c Release
</code></pre>
<blockquote class="blockquote">
<p>Note: This will publish the web app in Framework dependent (Meaning that ASP.NET Core runtime has to be installed on the server) and cross-platform (Meaning that it can work on any operating system) mode. You might need to publish it for a specific platform if you're using native libraries or one of your <em>Nuget</em> packages uses them by using the <a href="https://docs.microsoft.com/en-us/dotnet/core/tools/dotnet-publish"><code>--runtime</code> switch</a>.</p>
</blockquote>
<p>Compress the contents of <code>bin\Release\netcoreapp3.1\publish\</code>  folder (and rename it to publish.zip) and upload it to <code>/home/www/sample</code> folder by dragging it into Explorer tab of VSCode.</p>
<p>Run these commands to unzip and delete the zip file:</p>
<pre><code>cd /home/www/sample
unzip publish.zip
rm publish.zip
</code></pre>
<p>Okay, now that all of the necessary files are on the server, you can now test if the app actually works:</p>
<pre><code>dotnet AspNetOnLinux.dll --urls=http://localhost:9999
</code></pre>
<p>If everything is set up correctly and port <code>9999</code> is not being used by any other processes, kestrel must be up and running now.</p>
<ul>
<li>If there were an exception like <code>System.IO.IOException: Failed to bind to address http://127.0.0.1:9999: address already in use.</code> Then change the port to something else.</li>
<li>If There was an error like <code>Command 'dotnet' not found</code> Then it means that ASP.NET Core runtime has not been installed properly. Install them and try again.</li>
</ul>
<p>Now that we have confirmed that everything works press next we need to configure Nginx as a reverse proxy, i.e. it listens for an external port on an IP address or domain name and re-routes it to kestrel.</p>
<h2 id="configuring-nginx">Configuring Nginx</h2>
<p>Keep kestrel running and open <strong>a new</strong> terminal in VSCode and run:</p>
<pre><code>code /etc/nginx/sites-available/default
</code></pre>
<p>This will open Nginx default configurations in VSCode.</p>
<pre><code>server {
    listen        IP_ADDRESS;
    server_name   HOST_NAME;
    location / {
        proxy_pass         KESTREL_URL;
        proxy_http_version 1.1;
        proxy_set_header   Upgrade $http_upgrade;
        proxy_set_header   Connection keep-alive;
        proxy_set_header   Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
    }
}
</code></pre>
<p>Copy the above snippet to the configuration file and make these adjustments:</p>
<ol>
<li>Instead of <code>IP_ADDRESS</code> write the external ip address to which you want Nginx to listen. Example: <code>8080</code>. If <code>HOST_NAME</code> is a domain name you might want to use port <code>80</code>.</li>
<li>Instead of <code>HOST_NAME</code> write the domain name or IP address you want Nginx to listen to. If you've rented a VM they usually give you a static public IP that you can use for this. or if you want to use a domain name, you need to configure its DNS settings so that it points to your server's public IP address.</li>
<li>Instead of <code>KESTREL_URL</code> write the URL you have kestrel listening to. Example: <code>http://localhost:9999</code></li>
</ol>
<p>Save the file and run this command for Nginx to reload the configuration file:</p>
<pre><code># Validate configuration file
nginx -t
# Reload configuration file
nginx -s reload
</code></pre>
<p>Now in a browser go to <code>http://HOST_NAME:IP_ADDRESS/</code> and it should show our web app running 😊</p>
<p>For more information on configuration Nginx go to <a href="https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/linux-nginx?view=aspnetcore-3.1">Microsoft docs</a>.</p>
<h2 id="setting-up-systemd">Setting up systemd</h2>
<p>Everything seems to be working now. But if you close the ssh session our website will no longer be running and Nginx will return <code>ERROR 502: Bad Gateway</code> if you visited the website. To make sure the website will always be running and will be restarted if it crashes we can use <code>systemd</code>.</p>
<p>Go back to the terminal that's running kestrel and press CTRL+C to stop it. And then run these commands:</p>
<pre><code>code /etc/systemd/system/sample.service
</code></pre>
<p>This will open up a blank file in VSCode. Write this configuration in the file:</p>
<pre><code>[Unit]
Description=Sample ASP.NET Core application

[Service]
WorkingDirectory=/home/www/sample
ExecStart=/usr/bin/dotnet /home/www/sample/sample.dll --urls=http://localhost:9999
Restart=always
# Restart service after 10 seconds if the dotnet service crashes:
RestartSec=10
KillSignal=SIGINT
SyslogIdentifier=dotnet-ec
User=root
# You can put your environment variables here:
Environment=ASPNETCORE_ENVIRONMENT=Production

[Install]
WantedBy=multi-user.target
</code></pre>
<p>Save it and then run these commands:</p>
<pre><code># Reload systemd configuration
systemctl daemon-reload

systemctl enable sample
systemctl start sample
</code></pre>
<p>You can verify that our application is up and running by running this command:</p>
<pre><code>systemctl status sample
</code></pre>
<p>It should not show any errors if everything has gone according to our plan. Press CTRL+C to stop showing status.</p>
<p>Now our sample web application will be running reliably and will be restarted if it crashed. You can close VSCode and visit <code>http://HOST_NAME:IP_ADDRESS/</code> and it should be serving requests.</p>
<hr />
<p>In the next post, we will talk about setting up a CI/CD pipeline using GitHub actions.</p>
<p>The code is available on  <a href="https://github.com/encrypt0r/AspNetOnLinux">GitHub</a>.</p>


<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'mazeez'; // required: replace example with your forum shortname
    var disqus_identifier = 'aspnet-on-linux-1';
    var disqus_title = 'Running ASP.NET Core on Linux Part 1';
    var disqus_url = 'https://mazeez.dev/posts/aspnet-on-linux-1';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                        </div>
                </div>
        </div>

        <hr>

        <!-- Footer -->
        <footer>
                <ul class="list-inline text-center">
                        <li>
                                <a href="https://twitter.com/mhmd_azeez">
                                        <span class="fa-stack fa-lg">
                                                <i class="fa fa-circle fa-stack-2x"></i>
                                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                        </span>
                                </a>
                        </li>

                        <li>
                                <a href="https://github.com/encrypt0r">
                                        <span class="fa-stack fa-lg">
                                                <i class="fa fa-circle fa-stack-2x"></i>
                                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                        </span>
                                </a>
                        </li>

                        
                        <li>
                                <a href="mailto:muhammad-azeez@outlook.com">
                                        <span class="fa-stack fa-lg">
                                                <i class="fa fa-circle fa-stack-2x"></i>
                                                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                                        </span>
                                </a>
                        </li>

                        
                        <li>
                                <a href="https://www.linkedin.com/in/muhammad-azeez/">
                                        <span class="fa-stack fa-lg">
                                                <i class="fa fa-circle fa-stack-2x"></i>
                                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                                        </span>
                                </a>
                        </li>
                </ul>

                <div class="container">
        <div class="row">
                <div class="col-md-12 text-center">
                    <p class="copyright text-muted">
                        Copyright © 2020
                        <br />
                            <a href="/feed.rss"><i class="fa fa-rss"></i> RSS Feed</a>
                        |
                            <a href="/feed.atom"><i class="fa fa-rss"></i> Atom Feed</a>
                        <br />
                        <strong><a href="https://wyam.io">Generated by Wyam</a></strong>
                    </p>
                </div>
        </div>
</div>

        </footer>

        
        <script>
                hljs.initHighlightingOnLoad();
                hljs.configure({
                        languages: []
                });
        </script>


        <script>
                BackgroundCheck.init({
                        targets: '.intro-header,.navbar',
                        images: '.intro-header'
                });
        </script>

        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-141113720-1"></script>
        <script>
                window.dataLayer = window.dataLayer || [];

                function gtag() {
                        dataLayer.push(arguments);
                }
                gtag('js', new Date());

                gtag('config', 'UA-141113720-1');
        </script>

</body>

</html>