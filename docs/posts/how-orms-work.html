
<!DOCTYPE html>
<html lang="en">

<head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge" />

        <title>Muhammad Azeez - How do Object Relational Mappers (like Entity Framework) work?</title>
        <meta name="description" content="A blog about software engineering and beyond!" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link type="application/rss+xml" rel="alternate" title="Muhammad Azeez"
                href="/feed.rss" />
                <link type="application/atom+xml" rel="alternate" title="Muhammad Azeez"
                href="/feed.atom" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">

        <link href="/assets/css/bootstrap.min.css" rel="stylesheet" />
        <link href="/assets/css/highlight.css" rel="stylesheet">
        <link href="/assets/css/clean-blog.css" rel="stylesheet" />
        <link href="/assets/css/master.css" rel="stylesheet" />
        <link href="/assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet'
                type='text/css'>
        <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800'
                rel='stylesheet' type='text/css'>
        <link href="/assets/css/override.css" rel="stylesheet" />


        <meta name="application-name" content="Muhammad Azeez" />
        <meta name="msapplication-tooltip" content="Muhammad Azeez" />
        <meta name="msapplication-starturl" content="/" />

        <meta property="og:title" content="Muhammad Azeez - How do Object Relational Mappers (like Entity Framework) work?" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://mazeez.dev/posts/how-orms-work" />
        <!-- TODO: More social graph meta tags -->

        <script src="/assets/js/jquery.min.js"> </script> <script
                src="/assets/js/bootstrap.min.js"> </script> <script
                src="/assets/js/highlight.pack.js"> </script> <script
                src="/assets/js/clean-blog.js"> </script> <script
                src="/assets/js/d3.v3.min.js"> </script> <script
                src="/assets/js/trianglify.min.js"> </script> <script
                src="/assets/js/Please-compressed.js"> </script> <script
                src="/assets/js/background-check.min.js"> </script> <!-- HTML5 Shim and Respond.js
                IE8 support of HTML5 elements and media queries -->
                <!-- WARNING: Respond.js doesn't work if you view the page via file:// 
                -->
        <!--[if lt IE 9]>
                <script src="/assets/js/html5shiv.js"></script>
                <script src="/assets/js/respond.min.js"></script>
        <![endif]-->

        


</head>

<body>

        <!-- Navigation -->
        <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
                <div class="container-fluid">
                        <!-- Brand and toggle get grouped for better mobile display -->
                        <div class="navbar-header page-scroll">
                                <button type="button" class="navbar-toggle" data-toggle="collapse"
                                        data-target="#navbar-collapse">
                                        <span class="sr-only">Toggle navigation</span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                </button>
                                <a class="navbar-brand" href="/">Muhammad Azeez
                                        </a> </div> <!-- Collect the nav links, forms, and other content for toggling
                                        -->
                                        <div class="collapse navbar-collapse" id="navbar-collapse">
                                                <ul class="nav navbar-nav navbar-right">
                                                                <li><a href="/posts">Archive</a></li>
        <li><a href="/tags">Tags</a></li>
        <li><a href="/about">About Me</a></li>

                                                </ul>
                                        </div>
                                        <!-- /.navbar-collapse -->
                        </div>
                        <!-- /.container -->
        </nav>

        <!-- Page Header -->
        <header class="intro-header" id="intro-header" style="background-image: url(&quot;/assets/images/cover.jpg&quot;)">
                <div class="container">
                        <div class="row">
                                <div class="col-md-12">

    
<div class="post-heading">
    <h1>How do Object Relational Mappers (like Entity Framework) work?</h1>
    <div class="meta">        
Published on Saturday, December 21, 2019<br>    </div>
        <div class="tags">
                    <a role="button" href="/tags/csharp" class="btn btn-default btn-xs">csharp</a>
                    <a role="button" href="/tags/ef" class="btn btn-default btn-xs">ef</a>
                    <a role="button" href="/tags/orm" class="btn btn-default btn-xs">orm</a>
        </div>     
</div>
                                </div>
                        </div>
                </div>
        </header>

        <!-- Main Content -->
        <div class="container">
                <div class="row">
                        <div id="content" class="col-md-12">
                                

<p>When connecting an app or website to a database, most of the time you're querying the database and mapping the result to strongly typed objects. If you've been using an ORM like Enitity Framework or a Micro-ORM like Dapper, they handle the mapping of the objects and translation of the queries between C# and SQL.</p>
<p><strong>This article is a part of the <a href="https://crosscuttingconcerns.com/The-Third-Annual-csharp-Advent">3rd annual C# advent calendar</a>.</strong></p>
<p>The idea of ORMs is simple, since most of the code mapping code is mechanical and repetitive, it's a very good candidate for automation. Lets assume we have a <code>Person</code> table with this schema:</p>
<table class="table">
<thead>
<tr>
<th>Column</th>
<th>DataType</th>
</tr>
</thead>
<tbody>
<tr>
<td>Id</td>
<td>int</td>
</tr>
<tr>
<td>Name</td>
<td>nvarchar(50)</td>
</tr>
<tr>
<td>Height</td>
<td>float</td>
</tr>
<tr>
<td>Birthdate</td>
<td>datetime</td>
</tr>
</tbody>
</table>
<p>And we have a corresponding <code>Person</code> class:</p>
<pre><code class="language-csharp">class Person
{
   public int Id { get; set; }
   public string Name { get; set; }
   public double Height { get; set; }
   public DateTime Birthdate { get; set; }
}
</code></pre>
<p>Here is the C# code if we manually retrieve the data and map it to a list of the <code>Person</code> class:</p>
<pre><code class="language-csharp">public async Task&lt;List&lt;Person&gt;&gt; GetPeople()
{
    var list = new List&lt;Person&gt;();

    var sql = &quot;SELECT Id, Name, Height, Birthdate From Person&quot;;

    using (var connection = new SqlConnection(ConnectionString))
    using (var command = new SqlCommand(sql, connection))
    {
        await connection.OpenAsync();

        using (var reader = await command.ExecuteReaderAsync())
        {
            while (await reader.ReadAsync())
            {
                var person = new Person
                {
                    Id = (int)reader[&quot;Id&quot;],
                    Name = (string)reader[&quot;Name&quot;],
                    Height = (double)reader[&quot;Height&quot;],
                    Birthdate = (DateTime)reader[&quot;Birthdate&quot;],
                };

                list.Add(person);
            }
        }
    }

    return list;
}
</code></pre>
<p>The SQL query and the mapping of columns to properties are the only two things that differ from one table/class to another. If only we can get the list of properties of a class and their types... Well, it turns out that we can!</p>
<p>System.Reflection.Type represents a .NET type. It has a lot of metadata about the type. We can get the list of the properties of a type by using the <code>GetProperties</code> method:</p>
<pre><code class="language-csharp">PropertyInfo[] properties = typeof(Person).GetProperties();
</code></pre>
<p>The <code>typeof</code> keyword is used to get the type of a class at compile time. The <code>PropertyInfo</code> class has many useful properties and methods, but we are only interested in these:</p>
<table class="table">
<thead>
<tr>
<th>Member</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Name</td>
<td>string</td>
<td>Gets the name for a property.</td>
</tr>
<tr>
<td>GetMethod</td>
<td>MethodInfo</td>
<td>Gets the <code>get</code> method of a property.</td>
</tr>
<tr>
<td>SetMethod</td>
<td>MethodInfo</td>
<td>Gets the <code>set</code> method of a property.</td>
</tr>
</tbody>
</table>
<p>For example, if we have this code:</p>
<pre><code class="language-csharp">var person = new Person
{
    Name = &quot;Ahmed&quot;,
    Height = 180.4,
    Birthdate = new DateTime(1998, 1, 1),
    Id = 24
};

var heightProperty = typeof(Person).GetProperty(nameof(Person.Height));
heightProperty.SetValue(person, 185);

var properies = typeof(Person).GetProperties();
foreach (var prop in properies)
{
    Console.WriteLine($&quot;{prop.Name} =&gt; {prop.GetValue(person)}&quot;);
}
</code></pre>
<p>This will be the output:</p>
<pre><code>Height =&gt; 185
Id =&gt; 24
Name =&gt; Ahmed
Birthdate =&gt; 1/1/1998 12:00:00 AM
</code></pre>
<p><strong>Note</strong>: It's interesting to see that because we fetched the metadata of <code>Height</code> above the loop using <code>GetProperty</code>, the order of returned properties from <code>GetProperties</code> has changed and <code>Height</code> is the first property.</p>
<p>As you can see, the value of height is changed from <code>180.4</code> to <code>185</code> by using reflection.</p>
<p>The second thing we needed was to generate an SQL query, which is very easy as well:</p>
<pre><code class="language-csharp">var columnNames = properties.Select(p =&gt; p.Name);
var columns = string.Join(&quot;, &quot;, columnNames);

var sql = $&quot;SELECT {columns} FROM {typeof(T).Name}&quot;;
Console.WriteLine(sql);
</code></pre>
<p><strong>Note</strong>: If you are not sure why <code>GetSelectQuery</code> has a <code>&lt;T&gt;</code> at the end, it's because the method is generic. It allows <code>GetSelectQuery&lt;T&gt;</code> to be called with any type the programmer likes. In the example above, we have used it with <code>Person</code>. Generics is a very powerful concept. You can learn more about generics from <a href="https://www.youtube.com/watch?v=J9Cwi45UtZU&amp;list=PLdbkZkVDyKZURWIWQOw2KubVRIsxdkflI">Jeremy Clark</a>.</p>
<p>This will be the output:</p>
<pre><code>SELECT Id, Name, Height, Birthdate FROM Person
</code></pre>
<p>If you take close look at the generated SQL query, it's exactly like our own hand written query. So now we can combine our new found knowledge to write a method that can query the database for any table we like and map the results to c# types:</p>
<pre><code class="language-csharp">public async Task&lt;List&lt;T&gt;&gt; GetAll&lt;T&gt;() where T : new()
{
    var list = new List&lt;T&gt;();

    var properties = typeof(T).GetProperties();

    var columnNames = properties.Select(p =&gt; p.Name);
    var columns = string.Join(&quot;, &quot;, columnNames);

    var sql = $&quot;SELECT {columns} FROM {typeof(T).Name}&quot;;

    using (var connection = new SqlConnection(ConnectionString))
    using (var command = new SqlCommand(sql, connection))
    {
        await connection.OpenAsync();

        using (var reader = await command.ExecuteReaderAsync())
        {
            while (await reader.ReadAsync())
            {
                var model = new T();

                foreach (var property in properties)
                {
                    property.SetValue(model, reader[property.Name]);
                }

                list.Add(model);
            }
        }
    }

    return list;
}
</code></pre>
<p><strong>Note</strong>: the <code>new()</code> constraint makes sure the <code>T</code> has a public constructor that takes no parameters. So that we can write <code>var model = new T();</code>.</p>
<p>And we can use it like so:</p>
<pre><code>List&lt;Person&gt; people = GetAll&lt;Person&gt;();
</code></pre>
<p>Pretty neat right?</p>
<p>And here is what <code>Insert</code> and <code>Update</code> would look like:</p>
<pre><code class="language-csharp">public async Task Insert&lt;T&gt;(T item)
{
    var properties = typeof(T).GetProperties();

    var columns = string.Join(&quot;, &quot;, properties.Select(p =&gt; p.Name));
    var columnParameters = string.Join(&quot;, &quot;, properties.Select(p =&gt; $&quot;&#64;{p.Name}&quot;));

    var sql = $&quot;INSERT INTO {typeof(T).Name} ({columns}) VALUES ({columnParameters})&quot;;

    using (var connection = new SqlConnection(ConnectionString))
    using (var command = new SqlCommand(sql, connection))
    {
        await connection.OpenAsync();

        foreach (var property in properties)
        {
            command.Parameters.AddWithValue($&quot;&#64;{property.Name}&quot;, property.GetValue(item));
        }

        await command.ExecuteNonQueryAsync();
    }
}

public async Task Update&lt;T&gt;(string idPropertyName, T item)
{
    var properties = typeof(T).GetProperties();

    var columnUpdates = properties.Where(p =&gt; p.Name != idPropertyName)
                                  .Select(p =&gt; $&quot;{p.Name} = &#64;{p.Name}&quot;);
    var columns = string.Join(&quot;, &quot;, columnUpdates);

    var sql = $&quot;UPDATE {typeof(T).Name} SET {columns} WHERE {idPropertyName} = &#64;{idPropertyName}&quot;;

    using (var connection = new SqlConnection(ConnectionString))
    using (var command = new SqlCommand(sql, connection))
    {
        await connection.OpenAsync();

        foreach (var property in properties)
        {
            command.Parameters.AddWithValue($&quot;&#64;{property.Name}&quot;, property.GetValue(item));
        }

        await command.ExecuteNonQueryAsync();
    }
}
</code></pre>
<p>As you can see, with a few lines of code we were able to implement a bare minimum Micro-ORM. But there are a lot of features in an ORM. One of them is that ORMs usually support multiple DBMSs, we only support MSSQL with our implementation here (Although for a simple mapper like this one, it's not very hard to support other DBMSs). Another thing would be providing a way to query the database (adding where clauses in the <code>GetAll</code> method). It's usually implemented using <a href="https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/concepts/expression-trees/"><code>ExpressionTree</code>s</a>.</p>
<p>And the way we have implemented, it won't have a very good performance. Some easy tricks to improve performance would be cache the <code>PropertyInfo</code>s for each type and reuse it, because reflection is very expensive. Actual ORMs much better optimized both in the c# side and in the way they generate SQL.</p>
<p>The code for this article is available <a href="https://github.com/encrypt0r/ORMSample">on GitHub</a>.</p>
<p><strong>Disclaimer</strong>: The sample codes in this article are for demonstration purposes alone and should NOT be used in production environments.</p>


<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'mazeez'; // required: replace example with your forum shortname
    var disqus_identifier = 'how-orms-work';
    var disqus_title = 'How do Object Relational Mappers (like Entity Framework) work?';
    var disqus_url = 'https://mazeez.dev/posts/how-orms-work';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                        </div>
                </div>
        </div>

        <hr>

        <!-- Footer -->
        <footer>
                <ul class="list-inline text-center">
                        <li>
                                <a href="https://twitter.com/mhmd_azeez">
                                        <span class="fa-stack fa-lg">
                                                <i class="fa fa-circle fa-stack-2x"></i>
                                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                        </span>
                                </a>
                        </li>

                        <li>
                                <a href="https://github.com/mhmd-azeez">
                                        <span class="fa-stack fa-lg">
                                                <i class="fa fa-circle fa-stack-2x"></i>
                                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                        </span>
                                </a>
                        </li>

                        
                        <li>
                                <a href="mailto:muhammad-azeez@outlook.com">
                                        <span class="fa-stack fa-lg">
                                                <i class="fa fa-circle fa-stack-2x"></i>
                                                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                                        </span>
                                </a>
                        </li>

                        
                        <li>
                                <a href="https://www.linkedin.com/in/muhammad-azeez/">
                                        <span class="fa-stack fa-lg">
                                                <i class="fa fa-circle fa-stack-2x"></i>
                                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                                        </span>
                                </a>
                        </li>
                </ul>

                <div class="container">
        <div class="row">
                <div class="col-md-12 text-center">
                    <p class="copyright text-muted">
                        Copyright © 2021
                        <br />
                            <a href="/feed.rss"><i class="fa fa-rss"></i> RSS Feed</a>
                        |
                            <a href="/feed.atom"><i class="fa fa-rss"></i> Atom Feed</a>
                        <br />
                        <strong><a href="https://wyam.io">Generated by Wyam</a></strong>
                    </p>
                </div>
        </div>
</div>

        </footer>

        
        <script>
                hljs.initHighlightingOnLoad();
                hljs.configure({
                        languages: []
                });
        </script>


        <script>
                BackgroundCheck.init({
                        targets: '.intro-header,.navbar',
                        images: '.intro-header'
                });
        </script>

        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-141113720-1"></script>
        <script>
                window.dataLayer = window.dataLayer || [];

                function gtag() {
                        dataLayer.push(arguments);
                }
                gtag('js', new Date());

                gtag('config', 'UA-141113720-1');
        </script>

</body>

</html>