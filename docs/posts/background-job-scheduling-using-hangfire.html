
<!DOCTYPE html>
<html lang="en">

<head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge" />

        <title>Muhammad Azeez - Background Job Scheduling using Hangfire</title>
        <meta name="description" content="A blog about software engineering and beyond!" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link type="application/rss+xml" rel="alternate" title="Muhammad Azeez"
                href="/feed.rss" />
                <link type="application/atom+xml" rel="alternate" title="Muhammad Azeez"
                href="/feed.atom" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">

        <link href="/assets/css/bootstrap.min.css" rel="stylesheet" />
        <link href="/assets/css/highlight.css" rel="stylesheet">
        <link href="/assets/css/clean-blog.css" rel="stylesheet" />
        <link href="/assets/css/master.css" rel="stylesheet" />
        <link href="/assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet'
                type='text/css'>
        <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800'
                rel='stylesheet' type='text/css'>
        <link href="/assets/css/override.css" rel="stylesheet" />


        <meta name="application-name" content="Muhammad Azeez" />
        <meta name="msapplication-tooltip" content="Muhammad Azeez" />
        <meta name="msapplication-starturl" content="/" />

        <meta property="og:title" content="Muhammad Azeez - Background Job Scheduling using Hangfire" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://mazeez.dev/posts/background-job-scheduling-using-hangfire" />
        <!-- TODO: More social graph meta tags -->

        <script src="/assets/js/jquery.min.js"> </script> <script
                src="/assets/js/bootstrap.min.js"> </script> <script
                src="/assets/js/highlight.pack.js"> </script> <script
                src="/assets/js/clean-blog.js"> </script> <script
                src="/assets/js/d3.v3.min.js"> </script> <script
                src="/assets/js/trianglify.min.js"> </script> <script
                src="/assets/js/Please-compressed.js"> </script> <script
                src="/assets/js/background-check.min.js"> </script> <!-- HTML5 Shim and Respond.js
                IE8 support of HTML5 elements and media queries -->
                <!-- WARNING: Respond.js doesn't work if you view the page via file:// 
                -->
        <!--[if lt IE 9]>
                <script src="/assets/js/html5shiv.js"></script>
                <script src="/assets/js/respond.min.js"></script>
        <![endif]-->

        


</head>

<body>

        <!-- Navigation -->
        <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
                <div class="container-fluid">
                        <!-- Brand and toggle get grouped for better mobile display -->
                        <div class="navbar-header page-scroll">
                                <button type="button" class="navbar-toggle" data-toggle="collapse"
                                        data-target="#navbar-collapse">
                                        <span class="sr-only">Toggle navigation</span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                </button>
                                <a class="navbar-brand" href="/">Muhammad Azeez
                                        </a> </div> <!-- Collect the nav links, forms, and other content for toggling
                                        -->
                                        <div class="collapse navbar-collapse" id="navbar-collapse">
                                                <ul class="nav navbar-nav navbar-right">
                                                                <li><a href="/posts">Archive</a></li>
        <li><a href="/tags">Tags</a></li>
        <li><a href="/about">About Me</a></li>

                                                </ul>
                                        </div>
                                        <!-- /.navbar-collapse -->
                        </div>
                        <!-- /.container -->
        </nav>

        <!-- Page Header -->
        <header class="intro-header" id="intro-header" style="background-image: url(&quot;/assets/images/cover.jpg&quot;)">
                <div class="container">
                        <div class="row">
                                <div class="col-md-12">

    
<div class="post-heading">
    <h1>Background Job Scheduling using Hangfire</h1>
    <div class="meta">        
Published on Saturday, December 5, 2020<br>    </div>
        <div class="tags">
                    <a role="button" href="/tags/hangfire" class="btn btn-default btn-xs">hangfire</a>
        </div>     
</div>
                                </div>
                        </div>
                </div>
        </header>

        <!-- Main Content -->
        <div class="container">
                <div class="row">
                        <div id="content" class="col-md-12">
                                

<blockquote class="blockquote">
<p><strong>Note:</strong> This post is part of C# <a href="https://www.csadvent.christmas/">Advent Calendar 2020</a>.</p>
</blockquote>
<p>Sometimes you've tasks that would take too much time to do in the request-response model. For example sending multiple emails. So you have to send the emails asynchronously (i.e. in the background) and returning a response before the jobs are done. Or maybe you want to do some task periodically. For example generating a resource-intensive report at midnight or sending monthly invoices to customers. In short, you want to be able to schedule jobs and be able to track their progress and see their results.</p>
<p>You can of course use an in-memory model and use ASP.NET Core's <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/host/hosted-services">IHostedService</a>. But then if the application restarts all of the scheduled jobs would be gone. So you need to persist the jobs so that they are not lost. And Maybe you want to have multiple workers (consumers) processing the background jobs and the works might be on different machines. And what about retrying jobs when they fail?</p>
<p><strong><a href="https://www.hangfire.io/">Hangfire</a></strong> is a library that helps you do all of that and more very easily. It's very popular and well tested. It's also customizable and supports different kinds of storage mechanisms. And it supports different styles and techniques of background job processing.</p>
<img src="../assets/images/posts/background-job-scheduling-using-hangfire/dashboard.jpg" width="800">
<h2 id="how-to-use-hangfire">How to use Hangfire</h2>
<p>We are going to host hangfire in an ASP.NET Core app and use SQLite for storage. You can also use MSSQL, PostgreSQL, MySQL and other database engines and host it in a console app. The <a href="https://docs.hangfire.io/en/latest/getting-started/aspnet-core-applications.html">official guide</a> is very good but here are the steps:</p>
<ol>
<li><p>Add these Nuget packages*:</p>
<pre><code class="language-xml">&lt;PackageReference Include=&quot;Hangfire.Core&quot; Version=&quot;1.7.18&quot; /&gt;
&lt;PackageReference Include=&quot;Hangfire.AspNetCore&quot; Version=&quot;1.7.18&quot; /&gt;
&lt;PackageReference Include=&quot;Hangfire.Storage.SQLite&quot; Version=&quot;0.2.4&quot; /&gt;
</code></pre>
</li>
<li><p>Add Hangfire to Dependency Container:</p>
<pre><code class="language-csharp">// Add Hangfire services.
services.AddHangfire(configuration =&gt; configuration
    .SetDataCompatibilityLevel(CompatibilityLevel.Version_170)
    .UseSimpleAssemblyNameTypeSerializer()
    .UseRecommendedSerializerSettings()
    .UseSQLiteStorage());

// Add the processing server as IHostedService
services.AddHangfireServer();
</code></pre>
</li>
<li><p>Define Hangfire Dashboard route:</p>
<pre><code class="language-csharp">app.UseEndpoints(endpoints =&gt;
{
    endpoints.MapRazorPages();
    endpoints.MapHangfireDashboard();
});
</code></pre>
</li>
</ol>
<p>Now you can run the app and go to <code>/hangfire</code> and see it. But there are no jobs yet.</p>
<h2 id="enqueuing-jobs">Enqueuing Jobs</h2>
<p>If you want to enqueue a job in a fire-and-forget fashion (i.e. you don't want to wait for the result and you don't care much about when exactly it's going to happen), you do something like this:</p>
<pre><code>backgroundJobs.Enqueue(() =&gt; Console.WriteLine(&quot;Hello world from Hangfire!&quot;));
</code></pre>
<p>What if you wanted to something that might require some dependencies. For example you need a connection to the database or access to configurations? Well, then you can create a class for the job and get your dependencies through Dependency Injection:</p>
<pre><code class="language-csharp">public class SendEmailsJob
{
    public SendEmailsJob(IConfiguration configuration)
    {
        // You can ask for configuration or any other
        // dependency the job might need via Dependency Injection
    }

    [JobDisplayName(&quot;Send {0} emails&quot;)]
    [AutomaticRetry(Attempts = 3)]
    public async Task Execute(int count)
    {
        for (int i = 0; i &lt; count; i++)
        {
            await Task.Delay(1000);
        }
    }
}
</code></pre>
<p>As you can see we have defined a method called <code>Execute</code> which accepts a parameter. We have also decorated it with some attributes to control how it's displayed in the Hangfire dashboard or how many times Hangfire would automatically retry the job if it fails.</p>
<p>And this is how you'd enqueue the job:</p>
<pre><code class="language-csharp">_backgroundJobClient.Enqueue&lt;SendEmailsJob&gt;(job =&gt; job.Execute(5));
</code></pre>
<h2 id="scheduling-jobs">Scheduling Jobs</h2>
<p>If you want a job to be executed periodically on a defined schedule, you can write something like this:</p>
<pre><code class="language-csharp">Hangfire.RecurringJob.AddOrUpdate&lt;SendEmailsJob&gt;(job =&gt; job.Execute(10), cronExpression: &quot;*/5 * * * *&quot;);
</code></pre>
<p><strong>Note:</strong> <code>RecurringJob</code> is a static class.</p>
<p>The job can be a simple expression or a class. And you define the schedule using a Cron Expression. You can construct Cron expressions through sites like <a href="https://crontab.cronhub.io/">this</a> and <a href="https://crontab.guru/">this</a>.</p>
<img src="../assets/images/posts/background-job-scheduling-using-hangfire/job.jpg" width="800">
<h2 id="extensions">Extensions</h2>
<p>Hangfire has a lot of extensions, you can check them out <a href="https://www.hangfire.io/extensions.html">here</a>. But my favorite extension is this one. Which lets you output real time logs :)</p>
<img src="https://github.com/pieceofsummer/Hangfire.Console/raw/master/dashboard.png" width="600" />
<p><strong>Note:</strong> The console is not real-time if you use SQLite as the storage engine.</p>
<h2 id="source-code">Source code</h2>
<p>I have put a sample application <a href="https://github.com/mhmd-azeez/HangfireDemo">here </a> which contains the codes in this article and the rest of the ASP.NET Core app.</p>


<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'mazeez'; // required: replace example with your forum shortname
    var disqus_identifier = 'background-job-scheduling-using-hangfire';
    var disqus_title = 'Background Job Scheduling using Hangfire';
    var disqus_url = 'https://mazeez.dev/posts/background-job-scheduling-using-hangfire';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                        </div>
                </div>
        </div>

        <hr>

        <!-- Footer -->
        <footer>
                <ul class="list-inline text-center">
                        <li>
                                <a href="https://twitter.com/mhmd_azeez">
                                        <span class="fa-stack fa-lg">
                                                <i class="fa fa-circle fa-stack-2x"></i>
                                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                        </span>
                                </a>
                        </li>

                        <li>
                                <a href="https://github.com/mhmd-azeez">
                                        <span class="fa-stack fa-lg">
                                                <i class="fa fa-circle fa-stack-2x"></i>
                                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                        </span>
                                </a>
                        </li>

                        
                        <li>
                                <a href="mailto:muhammad-azeez@outlook.com">
                                        <span class="fa-stack fa-lg">
                                                <i class="fa fa-circle fa-stack-2x"></i>
                                                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                                        </span>
                                </a>
                        </li>

                        
                        <li>
                                <a href="https://www.linkedin.com/in/muhammad-azeez/">
                                        <span class="fa-stack fa-lg">
                                                <i class="fa fa-circle fa-stack-2x"></i>
                                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                                        </span>
                                </a>
                        </li>
                </ul>

                <div class="container">
        <div class="row">
                <div class="col-md-12 text-center">
                    <p class="copyright text-muted">
                        Copyright © 2021
                        <br />
                            <a href="/feed.rss"><i class="fa fa-rss"></i> RSS Feed</a>
                        |
                            <a href="/feed.atom"><i class="fa fa-rss"></i> Atom Feed</a>
                        <br />
                        <strong><a href="https://wyam.io">Generated by Wyam</a></strong>
                    </p>
                </div>
        </div>
</div>

        </footer>

        
        <script>
                hljs.initHighlightingOnLoad();
                hljs.configure({
                        languages: []
                });
        </script>


        <script>
                BackgroundCheck.init({
                        targets: '.intro-header,.navbar',
                        images: '.intro-header'
                });
        </script>

        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-141113720-1"></script>
        <script>
                window.dataLayer = window.dataLayer || [];

                function gtag() {
                        dataLayer.push(arguments);
                }
                gtag('js', new Date());

                gtag('config', 'UA-141113720-1');
        </script>

</body>

</html>