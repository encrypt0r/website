
<!DOCTYPE html>
<html lang="en">

<head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge" />

        <title>Muhammad Azeez - Enabling automatic updates for sideloaded UWP apps: Multiple update channels</title>
        <meta name="description" content="A blog about software engineering and beyond!" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link type="application/rss+xml" rel="alternate" title="Muhammad Azeez"
                href="/feed.rss" />
                <link type="application/atom+xml" rel="alternate" title="Muhammad Azeez"
                href="/feed.atom" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">

        <link href="/assets/css/bootstrap.min.css" rel="stylesheet" />
        <link href="/assets/css/highlight.css" rel="stylesheet">
        <link href="/assets/css/clean-blog.css" rel="stylesheet" />
        <link href="/assets/css/master.css" rel="stylesheet" />
        <link href="/assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet'
                type='text/css'>
        <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800'
                rel='stylesheet' type='text/css'>
        <link href="/assets/css/override.css" rel="stylesheet" />


        <meta name="application-name" content="Muhammad Azeez" />
        <meta name="msapplication-tooltip" content="Muhammad Azeez" />
        <meta name="msapplication-starturl" content="/" />

        <meta property="og:title" content="Muhammad Azeez - Enabling automatic updates for sideloaded UWP apps: Multiple update channels" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://mazeez.dev/posts/update-sideloaded-uwp-2" />
        <!-- TODO: More social graph meta tags -->

        <script src="/assets/js/jquery.min.js"> </script> <script
                src="/assets/js/bootstrap.min.js"> </script> <script
                src="/assets/js/highlight.pack.js"> </script> <script
                src="/assets/js/clean-blog.js"> </script> <script
                src="/assets/js/d3.v3.min.js"> </script> <script
                src="/assets/js/trianglify.min.js"> </script> <script
                src="/assets/js/Please-compressed.js"> </script> <script
                src="/assets/js/background-check.min.js"> </script> <!-- HTML5 Shim and Respond.js
                IE8 support of HTML5 elements and media queries -->
                <!-- WARNING: Respond.js doesn't work if you view the page via file:// 
                -->
        <!--[if lt IE 9]>
                <script src="/assets/js/html5shiv.js"></script>
                <script src="/assets/js/respond.min.js"></script>
        <![endif]-->

        


</head>

<body>

        <!-- Navigation -->
        <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
                <div class="container-fluid">
                        <!-- Brand and toggle get grouped for better mobile display -->
                        <div class="navbar-header page-scroll">
                                <button type="button" class="navbar-toggle" data-toggle="collapse"
                                        data-target="#navbar-collapse">
                                        <span class="sr-only">Toggle navigation</span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                </button>
                                <a class="navbar-brand" href="/">Muhammad Azeez
                                        </a> </div> <!-- Collect the nav links, forms, and other content for toggling
                                        -->
                                        <div class="collapse navbar-collapse" id="navbar-collapse">
                                                <ul class="nav navbar-nav navbar-right">
                                                                <li><a href="/posts">Archive</a></li>
        <li><a href="/tags">Tags</a></li>
        <li><a href="/about">About Me</a></li>
        <li><a href="/projects">Projects</a></li>

                                                </ul>
                                        </div>
                                        <!-- /.navbar-collapse -->
                        </div>
                        <!-- /.container -->
        </nav>

        <!-- Page Header -->
        <header class="intro-header" id="intro-header" style="background-image: url(&quot;/assets/images/cover.jpg&quot;)">
                <div class="container">
                        <div class="row">
                                <div class="col-md-12">

    
<div class="post-heading">
    <h1>Enabling automatic updates for sideloaded UWP apps: Multiple update channels</h1>
    <div class="meta">        
Published on Saturday, April 25, 2020<br>    </div>
        <div class="tags">
                    <a role="button" href="/tags/devops" class="btn btn-default btn-xs">devops</a>
                    <a role="button" href="/tags/uwp" class="btn btn-default btn-xs">uwp</a>
        </div>     
</div>
                                </div>
                        </div>
                </div>
        </header>

        <!-- Main Content -->
        <div class="container">
                <div class="row">
                        <div id="content" class="col-md-12">
                                

<p>In a <a href="https://mazeez.dev/posts/update-sideloaded-uwp">previous</a> post we talked about getting more control over the update process in sideloaded UWP apps. And in <a href="https://mazeez.dev/posts/uwp-devops">another post</a> we talked about setting up CI/CD pipelines for UWP apps. This time we will talk about how to create multiple update channels, i.e. alpha, beta, stable, for our UWP app.</p>
<p>The idea is very simple, and although I am going to use Azure Blob Storage, nothing stops you from using a normal web host.</p>
<h2 id="build-pipeline">Build Pipeline</h2>
<p>All of the channels should use the same build pipeline. The pipeline builds and signs the UWP. I have talked about setting up a build pipeline for UWP apps <a href="https://mazeez.dev/posts/uwp-devops">here</a>. You don't need to change much.</p>
<h2 id="release-pipeline">Release Pipeline</h2>
<p>All of the magic happens in the release pipeline. We can have multiple update channels by creating multiple containers in Azure DevOps (or using different prefixes, whichever you like more) for each channel.</p>
<p><img src="../assets/images/posts/update-sideloaded-uwp-2/channels.png" class="img-fluid" alt="channels" /></p>
<blockquote class="blockquote">
<p>Note: When creating the storage account, set the the performance tier to <code>Standard</code> (<code>Premium</code> only supports <code>Page Blob</code>s) and when creating the containers set the container access level to <code>Blob</code>.</p>
</blockquote>
<p>Now for each channel, we create a stage in the release pipeline</p>
<p><img src="../assets/images/posts/update-sideloaded-uwp-2/release-stages.png" class="img-fluid" alt="release-stages" /></p>
<p>Between each step we can have various approval processes or gates, Azure Pipelines makes these kinds of things incredibly easy.</p>
<p>The stages are very similar, here is what each stage has to do:</p>
<p><img src="../assets/images/posts/update-sideloaded-uwp-2/stage.png" class="img-fluid" alt="stage" /></p>
<h3 id="change-index.html-and.installer-urls">1. Change index.html and .installer urls</h3>
<p>Because we now have multiple channels, each channel will have its own url. So we have to change <code>index.html</code> and the <code>.appinstaller</code> file to reflect the channels' URL. This can be done easily via a simple PowerShell script.</p>
<pre><code class="language-powershell">Write-Host &quot;Changing urls for beta channel...&quot;

$oldUrl = &quot;Old URL HERE&quot;
$newUrl = &quot;https://YOUR-STORAGE-ACCOUNT-HERE.blob.core.windows.net/beta&quot;

$folder = &quot;$(System.DefaultWorkingDirectory)/BUILD-ARTIFICAT-NAME/drop/AppxPackages&quot;

$htmlPath = &quot;$folder/index.html&quot;
$installerPath = &quot;$folder/APP-NAME.appinstaller&quot;

((Get-Content -path $htmlPath -Raw) -replace $oldUrl,$newUrl) | Set-Content -Path $htmlPath
((Get-Content -path $installerPath -Raw) -replace $oldUrl,$newUrl) | Set-Content -Path $installerPath
</code></pre>
<h3 id="delete-old-versions-to-reduce-cost">2. Delete old versions to reduce cost</h3>
<p>Although Azure Blob Storage is very cheap, UWP apps can become very large, ours is about 300 MB when compiled in <code>Release</code> configuration for both <code>x64</code> and <code>x86</code> architectures. So in order to make sure we don't store too much data, we will delete the older versions and only leave the last N versions.</p>
<p>For this we can use the <a href="https://github.com/microsoft/azure-pipelines-tasks/blob/master/Tasks/AzureCLIV2/Readme.md">Azure CLI</a> task. It's similar to a Powershell script, but you're already logged in to your azure subscription. In the script part we can use something like this:</p>
<blockquote class="blockquote">
<p>Note: Azure CLI added support for PowerShell scripts in v2.</p>
</blockquote>
<pre><code class="language-powershell">$container = &quot;beta&quot;
$accountName = &quot;STORAGE-ACCOUNT-NAME&quot;

# Get List of blobs in the container and deserialize the list
$blobs = az storage blob list -c $container --prefix APP-NAME-HERE_ --account-name $accountName | convertFrom-json

# Create a HashTable so that we can store the name of the directory and its creation time
$dict = &#64;{}

Foreach($blob in $blobs)
{
    $versionName = $blob | Select-Object -ExpandProperty name
    $versionName = $versionName.split(&quot;/&quot;)[0]

    $date = $blob | Select-Object -ExpandProperty properties | Select-Object -ExpandProperty creationTime
    $date = [datetime]$date

    $dict[$versionName] = $date
}

# Sort the directories by their creation time and skip the top 2 (we don't want to remove last 2 version)
$ordered = $dict.GetEnumerator() | Sort-Object -Property Value -Descending | Select-Object -Skip 2

Write-Host Deleting obsolete versions...
Foreach($blob in $ordered)
{
    # APP-NAME_1.0.1.0_Test =&gt; APP-NAME_1.0.1.0_Test/*
    $dir = $blob.Key + &quot;/*&quot;
    az storage blob delete-batch -s $container --pattern $dir --account-name $accountName
    Write-Host $blob.Key &quot; - &quot; $blob.Value
}

Write-Host Done
</code></pre>
<h3 id="copy-the-build-artifact-to-channel-container">3. Copy the build artifact to channel container</h3>
<p>We can use the amazingly fast <a href="https://github.com/microsoft/azure-pipelines-tasks/blob/master/Tasks/AzureFileCopyV1/README.md">AzureBlob File Copy</a> task to upload the build artifact to azure blob storage. Using it is straightforward, you give it a folder to upload and the name of the container as well as the subscription and it uploads the specified files in no time.</p>
<h3 id="optional-upload-the-uwp-symbols-to-appcenter">4. (Optional) Upload the UWP symbols to AppCenter</h3>
<p>This only needs to be done in the first stage. In order for AppCenter crashes to give you detailed stack traces, it needs the symbols to translate memory addresses to function and class names. You can find more <a href="https://docs.microsoft.com/en-us/appcenter/diagnostics/windows-support#symbolication">details here</a>.</p>
<p>I have used the <a href="https://github.com/microsoft/appcenter-cli">appcenter cli</a> to upload the symbols.</p>
<pre><code class="language-powershell"># AppCenter UWP symbolication
# https://docs.microsoft.com/en-us/appcenter/diagnostics/windows-support#symbolication

# Install appcenter cli
# https://github.com/microsoft/appcenter-cli
npm install -g appcenter-cli

# Login to AppCenter
appcenter login --token $env:AppCenterToken --quiet

# Get the path fo the symbol files (64 bit and 32 bit)
$symbolFiles = Get-ChildItem *.appxsym -Recurse -Force | Select-Object -ExpandProperty FullName

# Upload the symbols
Foreach($symbolFile in $symbolFiles)
{
    Write-Host &quot;Uploading $symbolFile...&quot;
    appcenter crashes upload-symbols --app ORGANIZATION-NAME/APP-NAME --appxsym $symbolFile
}
</code></pre>
<blockquote class="blockquote">
<p>Note: in the current version, appcenter cli seems to use some deprecated libraries. So I have set <code>Fail on Standard Error</code> to false on the Powershell task so that the task doesn't fail.</p>
<p>Note2: I am using Azure Pipelines secrets to pass the AppCenter token to appcenter cli. For that, you have to explicitly map the secret to an environment variable in the <code>Environment Variables</code> part of the Powershell task.</p>
</blockquote>
<p>Congratulations! Now you've got yourself a decent multichannel auto-update process. All that remains is to teach the UWP app to look at different <code>.appinstaller</code> files based on which update channel its listening on.</p>


<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'mazeez'; // required: replace example with your forum shortname
    var disqus_identifier = 'update-sideloaded-uwp-2';
    var disqus_title = 'Enabling automatic updates for sideloaded UWP apps: Multiple update channels';
    var disqus_url = 'https://mazeez.dev/posts/update-sideloaded-uwp-2';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                        </div>
                </div>
        </div>

        <hr>

        <!-- Footer -->
        <footer>
                <ul class="list-inline text-center">
                        <li>
                                <a href="https://twitter.com/mhmd_azeez">
                                        <span class="fa-stack fa-lg">
                                                <i class="fa fa-circle fa-stack-2x"></i>
                                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                        </span>
                                </a>
                        </li>

                        <li>
                                <a href="https://github.com/encrypt0r">
                                        <span class="fa-stack fa-lg">
                                                <i class="fa fa-circle fa-stack-2x"></i>
                                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                        </span>
                                </a>
                        </li>

                        
                        <li>
                                <a href="mailto:muhammad-azeez@outlook.com">
                                        <span class="fa-stack fa-lg">
                                                <i class="fa fa-circle fa-stack-2x"></i>
                                                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                                        </span>
                                </a>
                        </li>

                        
                        <li>
                                <a href="https://www.linkedin.com/in/muhammad-azeez/">
                                        <span class="fa-stack fa-lg">
                                                <i class="fa fa-circle fa-stack-2x"></i>
                                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                                        </span>
                                </a>
                        </li>
                </ul>

                <div class="container">
        <div class="row">
                <div class="col-md-12 text-center">
                    <p class="copyright text-muted">
                        Copyright © 2020
                        <br />
                            <a href="/feed.rss"><i class="fa fa-rss"></i> RSS Feed</a>
                        |
                            <a href="/feed.atom"><i class="fa fa-rss"></i> Atom Feed</a>
                        <br />
                        <strong><a href="https://wyam.io">Generated by Wyam</a></strong>
                    </p>
                </div>
        </div>
</div>

        </footer>

        
        <script>
                hljs.initHighlightingOnLoad();
                hljs.configure({
                        languages: []
                });
        </script>


        <script>
                BackgroundCheck.init({
                        targets: '.intro-header,.navbar',
                        images: '.intro-header'
                });
        </script>

        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-141113720-1"></script>
        <script>
                window.dataLayer = window.dataLayer || [];

                function gtag() {
                        dataLayer.push(arguments);
                }
                gtag('js', new Date());

                gtag('config', 'UA-141113720-1');
        </script>

</body>

</html>