
<!DOCTYPE html>
<html lang="en">

<head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge" />

        <title>Muhammad Azeez - Writing Native Libraries in C# and using them in other languages</title>
        <meta name="description" content="A blog about software engineering and beyond!" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link type="application/rss+xml" rel="alternate" title="Muhammad Azeez"
                href="/feed.rss" />
                <link type="application/atom+xml" rel="alternate" title="Muhammad Azeez"
                href="/feed.atom" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">

        <link href="/assets/css/bootstrap.min.css" rel="stylesheet" />
        <link href="/assets/css/highlight.css" rel="stylesheet">
        <link href="/assets/css/clean-blog.css" rel="stylesheet" />
        <link href="/assets/css/master.css" rel="stylesheet" />
        <link href="/assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet'
                type='text/css'>
        <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800'
                rel='stylesheet' type='text/css'>
        <link href="/assets/css/override.css" rel="stylesheet" />


        <meta name="application-name" content="Muhammad Azeez" />
        <meta name="msapplication-tooltip" content="Muhammad Azeez" />
        <meta name="msapplication-starturl" content="/" />

        <meta property="og:title" content="Muhammad Azeez - Writing Native Libraries in C# and using them in other languages" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://mazeez.dev/posts/writing-native-libraries-in-csharp" />
        <!-- TODO: More social graph meta tags -->

        <script src="/assets/js/jquery.min.js"> </script> <script
                src="/assets/js/bootstrap.min.js"> </script> <script
                src="/assets/js/highlight.pack.js"> </script> <script
                src="/assets/js/clean-blog.js"> </script> <script
                src="/assets/js/d3.v3.min.js"> </script> <script
                src="/assets/js/trianglify.min.js"> </script> <script
                src="/assets/js/Please-compressed.js"> </script> <script
                src="/assets/js/background-check.min.js"> </script> <!-- HTML5 Shim and Respond.js
                IE8 support of HTML5 elements and media queries -->
                <!-- WARNING: Respond.js doesn't work if you view the page via file:// 
                -->
        <!--[if lt IE 9]>
                <script src="/assets/js/html5shiv.js"></script>
                <script src="/assets/js/respond.min.js"></script>
        <![endif]-->

        


</head>

<body>

        <!-- Navigation -->
        <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
                <div class="container-fluid">
                        <!-- Brand and toggle get grouped for better mobile display -->
                        <div class="navbar-header page-scroll">
                                <button type="button" class="navbar-toggle" data-toggle="collapse"
                                        data-target="#navbar-collapse">
                                        <span class="sr-only">Toggle navigation</span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                </button>
                                <a class="navbar-brand" href="/">Muhammad Azeez
                                        </a> </div> <!-- Collect the nav links, forms, and other content for toggling
                                        -->
                                        <div class="collapse navbar-collapse" id="navbar-collapse">
                                                <ul class="nav navbar-nav navbar-right">
                                                                <li><a href="/posts">Archive</a></li>
        <li><a href="/tags">Tags</a></li>
        <li><a href="/about">About Me</a></li>
        <li><a href="/projects">Projects</a></li>

                                                </ul>
                                        </div>
                                        <!-- /.navbar-collapse -->
                        </div>
                        <!-- /.container -->
        </nav>

        <!-- Page Header -->
        <header class="intro-header" id="intro-header" style="background-image: url(&quot;/assets/images/cover.jpg&quot;)">
                <div class="container">
                        <div class="row">
                                <div class="col-md-12">

    
<div class="post-heading">
    <h1>Writing Native Libraries in C# and using them in other languages</h1>
    <div class="meta">        
Published on Friday, May 3, 2019<br>    </div>
        <div class="tags">
                    <a role="button" href="/tags/corert" class="btn btn-default btn-xs">corert</a>
                    <a role="button" href="/tags/csharp" class="btn btn-default btn-xs">csharp</a>
        </div>     
</div>
                                </div>
                        </div>
                </div>
        </header>

        <!-- Main Content -->
        <div class="container">
                <div class="row">
                        <div id="content" class="col-md-12">
                                

<p>Recently I stumbled upon <a href="https://medium.com/&#64;MStrehovsky/fight-the-global-warming-compile-your-c-apps-ahead-of-time-9997e953645b">this article</a> from <a href="https://twitter.com/MStrehovsky">Michal Strehovsky</a>. It was a great introduction to CoreRT, it made me curious, can you write native libraries with CoreRT? and the answer was Yes!</p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">CoreRT can generate .dll/.so/.dylib and .lib/.a files that export C# functions in a way that makes them directly callable through standard FFI. A sample walkthrough is here: <a href="https://t.co/7N0ll44jMA">https://t.co/7N0ll44jMA</a></p>&mdash; Michal Strehovský (@MStrehovsky) <a href="https://twitter.com/MStrehovsky/status/1123859217654460424?ref_src=twsrc%5Etfw">May 2, 2019</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>I have a little library that I want to be available for multiple languages, so I was quite interested in it. So I tried out the <a href="https://github.com/dotnet/corert/tree/master/samples/NativeLibrary">official sample</a> and was delighted with the results.</p>
<p>I compiled the library using <code>dotnet publish /p:NativeLib=Shared -r win-x64 -c Release</code> and it produced a 4.52 MB dll. With the help of Michal and by following the steps of <a href="https://github.com/dotnet/corert/blob/master/Documentation/using-corert/optimizing-corert.md">this article</a>, I was able to get the size down to 1.67 MB, which is good enough for me.</p>
<p>The official sample has <a href="https://github.com/dotnet/corert/blob/master/samples/NativeLibrary/Class1.cs">a class</a> that contains two methods: <code>Add</code> and <code>WriteLine</code> which demonstrate how to take primitives and strings as parameters. By default, CoreRT only allows primitives as parameter types, you'll have to marshal anything else that's more complex. However, <code>System.Runtime.InteropServices.Marshal</code> does some have helpful methods.</p>
<pre><code class="language-csharp">public class Class1
{
    [NativeCallable(EntryPoint = &quot;add&quot;, CallingConvention = CallingConvention.StdCall)]
    public static int Add(int a, int b)
    {
        return a + b;
    }

    [NativeCallable(EntryPoint = &quot;write_line&quot;, CallingConvention = CallingConvention.StdCall)]
    public static int WriteLine(IntPtr pString)
    {
        // The marshalling code is typically auto-generated by a custom tool in larger projects.
        try
        {
            // NativeCallable methods only accept primitive arguments. The primitive arguments
            // have to be marshalled manually if necessary.
            string str = Marshal.PtrToStringAnsi(pString);

            Console.WriteLine(str);
        }
        catch
        {
            // Exceptions escaping out of NativeCallable methods are treated as unhandled exceptions.
            // The errors have to be marshalled manually if necessary.
            return -1;
        }
        return 0;
    }
}

</code></pre>
<p>The methods that are decorated with <code>NativeCallable</code> cannot be called through normal C# methods, but they can be called through P/Invoke 😈.</p>
<p>To do that, you have to:</p>
<ol>
<li>Build the native library by running <code>dotnet publish /p:NativeLib=Shared -r win-x64 -c Release</code> in its folder.</li>
<li>Create a new console app (I created a dotnet core console app, but it doesn't matter).</li>
<li>Right click on the project and click <code>Add =&gt; Exisiting Item</code>.</li>
<li>Browse to <code>bin\Release\netcoreapp2.2\win-x64\native</code> folder of the native library project and then select the dll and click on <code>Add As Link</code>.</li>
<li>Right Click on the dll in Solution Explorer and click on properties.</li>
<li>Change <code>Copy to Output Directory</code> to <code>Copy if newer</code>.</li>
<li>Change Solutions Platform to <code>x64</code>
<img src="https://thepracticaldev.s3.amazonaws.com/i/czdhpxbk35a55er415n3.PNG" class="img-fluid" alt="Solutions Platform" /></li>
<li>And then change the code in <code>Program.cs</code> as follows:</li>
</ol>
<pre><code class="language-csharp">class Program
{
    [DllImport(&quot;NativeLibrary.dll&quot;, EntryPoint = &quot;add&quot;, CallingConvention = CallingConvention.StdCall)]
    public static extern int Add(int a, int b);

    [DllImport(&quot;NativeLibrary.dll&quot;, EntryPoint = &quot;write_line&quot;, CallingConvention = CallingConvention.StdCall)]
    public static extern void WriteLine(string text);

    static void Main(string[] args)
    {
        var result = Add(1, 2);
        WriteLine(result.ToString());
        WriteLine(&quot;Hello World!&quot;);
    }
}

</code></pre>
<p>Now run the console app and you'll get an output like this:</p>
<pre><code>3
Hello World!
</code></pre>
<p><img src="https://thepracticaldev.s3.amazonaws.com/i/84kbvfvss1xwiy7vnvbx.gif" class="img-fluid" alt="But Why?" /></p>
<p>Now p/invoking the library might not be very useful, but compiling a class library as a native library opens doors for other languages to call the library.</p>
<p>It was a long and painful process, but I was eventually able to reference the library from the C++ app. This <a href="https://youtu.be/or1dAmUO8k0">video</a> and this <a href="https://docs.microsoft.com/en-us/cpp/build/walkthrough-creating-and-using-a-dynamic-link-library-cpp?view=vs-2019">article</a> were super helpful.</p>
<p>Here are the steps:</p>
<ol>
<li><p>Add an empty C++ project to the solution.</p>
</li>
<li><p>Add a source file and paste in this code snippet:</p>
</li>
</ol>
<pre><code class="language-cpp">#include &lt;iostream&gt;
#include &lt;NativeLibrary.h&gt;
using namespace std;

void main()
{
    int result = add(1, 2);
    cout &lt;&lt; result &lt;&lt; endl;
    write_line(&quot;Hello World!&quot;);
}
</code></pre>
<ol start="3">
<li>Create a new header file called <code>NativeLibrary.h</code> (That's the name of the library) and paste in this code snippet:</li>
</ol>
<pre><code class="language-cpp">#pragma once
extern &quot;C&quot; int __stdcall add(int a, int b);
extern &quot;C&quot; void __stdcall write_line(const char* pString);
</code></pre>
<p>As you can see have written the signatures of the functions that are exported from <code>NativeLibrary</code>.</p>
<ol start="4">
<li><p>Right Click on the C++ project and Click on Properties.</p>
</li>
<li><p>Choose <code>All Configurations</code> from <code>Configuration:</code>. This will make sure that the changes apply to both <code>Release</code> and <code>Debug</code> configurations (And any other configuration you might have).</p>
</li>
<li><p>Go to General and change <code>Output Directory</code> to <code>$(ProjectDir)bin\$(Platform)\$(Configuration)\</code>. This is not necessary, but I felt more at home like this.</p>
</li>
<li><p>Go to <code>C\C++</code> &gt; <code>Linker</code> &gt; <code>General</code> and add <code>$(SolutionDir)NativeLibrary\bin\Release\netcoreapp2.2\win-x64\native</code> to <code>Additional Library Directories</code>. This allows the linker to discover <code>NativeLibrary.lib</code>.</p>
</li>
<li><p>Go to <code>C\C++</code> &gt; <code>Linker</code> &gt; <code>Input</code> and add <code>NativeLibrary.lib</code> to the list of <code>Additional Dependencies</code>.</p>
</li>
<li><p>Go to <code>Build Events</code> &gt; <code>Post-Build Event</code> and paste in this code snippet to <code>Command Line</code>:</p>
</li>
</ol>
<pre><code>xcopy /y /d &quot;$(SolutionDir)NativeLibrary\bin\Release\netcoreapp2.2\win-x64\native\NativeLibrary.dll&quot; &quot;$(OutDir)&quot;
</code></pre>
<p>This will copy <code>NativeLibrary.dll</code> to the output dir whenever you build the C++ project.</p>
<ol start="10">
<li>Build and run the application and you should see this output:</li>
</ol>
<pre><code>3
Hello World!
</code></pre>
<p>If this is not cool, I don't know what is.</p>
<p>The source code is <a href="https://github.com/encrypt0r/CoreRTDemo">available on GitHub</a>.</p>


<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'mazeez'; // required: replace example with your forum shortname
    var disqus_identifier = 'writing-native-libraries-in-csharp';
    var disqus_title = 'Writing Native Libraries in C# and using them in other languages';
    var disqus_url = 'https://mazeez.dev/posts/writing-native-libraries-in-csharp';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                        </div>
                </div>
        </div>

        <hr>

        <!-- Footer -->
        <footer>
                <ul class="list-inline text-center">
                        <li>
                                <a href="https://twitter.com/mhmd_azeez">
                                        <span class="fa-stack fa-lg">
                                                <i class="fa fa-circle fa-stack-2x"></i>
                                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                        </span>
                                </a>
                        </li>

                        <li>
                                <a href="https://github.com/encrypt0r">
                                        <span class="fa-stack fa-lg">
                                                <i class="fa fa-circle fa-stack-2x"></i>
                                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                        </span>
                                </a>
                        </li>

                        
                        <li>
                                <a href="mailto:muhammad-azeez@outlook.com">
                                        <span class="fa-stack fa-lg">
                                                <i class="fa fa-circle fa-stack-2x"></i>
                                                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                                        </span>
                                </a>
                        </li>

                        
                        <li>
                                <a href="https://www.linkedin.com/in/muhammad-azeez/">
                                        <span class="fa-stack fa-lg">
                                                <i class="fa fa-circle fa-stack-2x"></i>
                                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                                        </span>
                                </a>
                        </li>
                </ul>

                <div class="container">
        <div class="row">
                <div class="col-md-12 text-center">
                    <p class="copyright text-muted">
                        Copyright © 2019
                        <br />
                            <a href="/feed.rss"><i class="fa fa-rss"></i> RSS Feed</a>
                        |
                            <a href="/feed.atom"><i class="fa fa-rss"></i> Atom Feed</a>
                        <br />
                        <strong><a href="https://wyam.io">Generated by Wyam</a></strong>
                    </p>
                </div>
        </div>
</div>

        </footer>

        <script>hljs.configure({languages: []});</script>
        <script>
                hljs.initHighlightingOnLoad();
                hljs.configure({
                        languages: []
                });
        </script>


        <script>
                BackgroundCheck.init({
                        targets: '.intro-header,.navbar',
                        images: '.intro-header'
                });
        </script>

        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-141113720-1"></script>
        <script>
                window.dataLayer = window.dataLayer || [];

                function gtag() {
                        dataLayer.push(arguments);
                }
                gtag('js', new Date());

                gtag('config', 'UA-141113720-1');
        </script>

</body>

</html>