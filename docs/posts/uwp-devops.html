
<!DOCTYPE html>
<html lang="en">

<head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge" />

        <title>Muhammad Azeez - Setting up automated build and release pipeline for side-loaded UWP apps using Azure DevOps</title>
        <meta name="description" content="A blog about software engineering and beyond!" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link type="application/rss+xml" rel="alternate" title="Muhammad Azeez"
                href="/feed.rss" />
                <link type="application/atom+xml" rel="alternate" title="Muhammad Azeez"
                href="/feed.atom" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">

        <link href="/assets/css/bootstrap.min.css" rel="stylesheet" />
        <link href="/assets/css/highlight.css" rel="stylesheet">
        <link href="/assets/css/clean-blog.css" rel="stylesheet" />
        <link href="/assets/css/master.css" rel="stylesheet" />
        <link href="/assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet'
                type='text/css'>
        <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800'
                rel='stylesheet' type='text/css'>
        <link href="/assets/css/override.css" rel="stylesheet" />


        <meta name="application-name" content="Muhammad Azeez" />
        <meta name="msapplication-tooltip" content="Muhammad Azeez" />
        <meta name="msapplication-starturl" content="/" />

        <meta property="og:title" content="Muhammad Azeez - Setting up automated build and release pipeline for side-loaded UWP apps using Azure DevOps" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://mazeez.dev/posts/uwp-devops" />
        <!-- TODO: More social graph meta tags -->

        <script src="/assets/js/jquery.min.js"> </script> <script
                src="/assets/js/bootstrap.min.js"> </script> <script
                src="/assets/js/highlight.pack.js"> </script> <script
                src="/assets/js/clean-blog.js"> </script> <script
                src="/assets/js/d3.v3.min.js"> </script> <script
                src="/assets/js/trianglify.min.js"> </script> <script
                src="/assets/js/Please-compressed.js"> </script> <script
                src="/assets/js/background-check.min.js"> </script> <!-- HTML5 Shim and Respond.js
                IE8 support of HTML5 elements and media queries -->
                <!-- WARNING: Respond.js doesn't work if you view the page via file:// 
                -->
        <!--[if lt IE 9]>
                <script src="/assets/js/html5shiv.js"></script>
                <script src="/assets/js/respond.min.js"></script>
        <![endif]-->

        


</head>

<body>

        <!-- Navigation -->
        <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
                <div class="container-fluid">
                        <!-- Brand and toggle get grouped for better mobile display -->
                        <div class="navbar-header page-scroll">
                                <button type="button" class="navbar-toggle" data-toggle="collapse"
                                        data-target="#navbar-collapse">
                                        <span class="sr-only">Toggle navigation</span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                </button>
                                <a class="navbar-brand" href="/">Muhammad Azeez
                                        </a> </div> <!-- Collect the nav links, forms, and other content for toggling
                                        -->
                                        <div class="collapse navbar-collapse" id="navbar-collapse">
                                                <ul class="nav navbar-nav navbar-right">
                                                                <li><a href="/posts">Archive</a></li>
        <li><a href="/tags">Tags</a></li>
        <li><a href="/about">About Me</a></li>
        <li><a href="/projects">Projects</a></li>

                                                </ul>
                                        </div>
                                        <!-- /.navbar-collapse -->
                        </div>
                        <!-- /.container -->
        </nav>

        <!-- Page Header -->
        <header class="intro-header" id="intro-header" style="background-image: url(&quot;/assets/images/cover.jpg&quot;)">
                <div class="container">
                        <div class="row">
                                <div class="col-md-12">

    
<div class="post-heading">
    <h1>Setting up automated build and release pipeline for side-loaded UWP apps using Azure DevOps</h1>
    <div class="meta">        
Published on Sunday, October 27, 2019<br>    </div>
        <div class="tags">
                    <a role="button" href="/tags/devops" class="btn btn-default btn-xs">devops</a>
                    <a role="button" href="/tags/uwp" class="btn btn-default btn-xs">uwp</a>
        </div>     
</div>
                                </div>
                        </div>
                </div>
        </header>

        <!-- Main Content -->
        <div class="container">
                <div class="row">
                        <div id="content" class="col-md-12">
                                

<p>This week we set up a CI/CD pipeline for one of our UWP apps that needs to be sideloaded because we don't publish it through the Microsoft Store. <a href="https://docs.microsoft.com/en-us/windows/uwp/packaging/auto-build-package-uwp-apps">This article</a> was super useful in getting me started. Microsoft has made things quite easy with Azure DevOps, but there were a few things that took us a little bit of time to figure out.</p>
<h2 id="a-little-bit-of-context">A little bit of context</h2>
<p>We have an enterprise UWP application that we publish via an http server. We also have a custom auto-update mechanism that updates the apps whenever an update is available. You can learn more about the <a href="https://mazeez.dev/posts/update-sideloaded-uwp">auto-updater here</a>.</p>
<p>So what we needed, is a build pipeline that builds the app for both <code>x64</code> and <code>x86</code> and generate an index.html page, <code>appinstaller</code> file and the <code>msixbundle</code> files for both the app and its dependencies.</p>
<h2 id="the-plan">The plan</h2>
<ol>
<li>Setup a build pipeline to generate update package and increase version</li>
<li>Set up a release pipeline to upload the update package via FTP</li>
<li>Celebrate</li>
</ol>
<h1 id="setting-up-a-build-pipeline">1. Setting up a build pipeline</h1>
<p><a href="https://docs.microsoft.com/en-us/windows/uwp/packaging/auto-build-package-uwp-apps">This article</a> provides most of the information needed. But I have a few notes:</p>
<h3 id="use-self-hosted-agents">1.1 Use self hosted agents</h3>
<p>Unfortunately, it seems like Microsoft hosted agents <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/hosted?view=azure-devops#capabilities-and-limitations">are not powerful enough</a> to build release modes of moderate to big UWP applications. Because in release mode, it has to compile the app natively and so uses the native compilation toolchain. In our experience, the native compilation toolchain requires at least 8 GB of RAM to work properly. For our app, the Microsft hosted agents had a build success rate of less than 50%. They fail because <a href="https://dev.to/encrypt0r/solving-nutcdriver-exe-returned-code-1-error-while-building-uwp-app-in-release-mode-2mc6">of memory usage issues</a>.</p>
<p>Besides, hosted agents are much faster. Microsoft hosted agents would take about 45 minutes to build our app, our own hosted agents usually take about 10 minutes. This is partly because they use incremental build, instead of a clean build every time they need to build the app.</p>
<p>So you have to use your own hosted agents. You use your own machines or virtual machines to build the application. Adding an agent to a pool is very easy:</p>
<ol>
<li>Go to project settings &gt; Agent Pools</li>
<li>Click on &quot;Default&quot; or create another pool</li>
<li>Click on &quot;New Agent&quot; and follow the instructions</li>
</ol>
<p>Now you will need to tell the build pipeline to use your self-hosted agents.
You can specify the pool name very easily in yaml:</p>
<pre><code class="language-yaml">pool:
  name: &quot;Default&quot;
</code></pre>
<p>You might also want to use the 64 bit compiler, for that add this xml snippet a <code>PropertyGroup</code> in your project's <code>csproj</code> file:</p>
<pre><code class="language-xml">&lt;Use64Bitcompiler&gt;true&lt;/Use64Bitcompiler&gt;
</code></pre>
<h3 id="use-nuget-version-4.x">1.2 Use Nuget version <code>4.x</code></h3>
<p>For some reason, not specifying Nuget version leads to the failure of the build.</p>
<h3 id="using-extension-sdks-with-a-build-pipeline">1.3 Using Extension SDKs with a build pipeline</h3>
<blockquote class="blockquote">
<p>An Extension SDK is similar in concept to a regular assembly reference, but is instead a rich collection of files to cover various configurations and design time scenarios.</p>
</blockquote>
<p>If you're using an SDK reference, for example if you use <a href="https://marketplace.visualstudio.com/items?itemName=SQLiteDevelopmentTeam.SQLiteforUniversalWindowsPlatform">SQLite for UWP</a>, you must include the SDK with the source code and tell MSBuild to use the local version before searching for the SDK in the global folder. <a href="https://oren.codes/2012/03/24/how-to-use-extension-sdks-per-project/">This article</a> explains the steps, but here is a summary:</p>
<ol>
<li>Create a folder beside your solution file and call it <code>SDKs</code>.</li>
<li>Copy UAP folder from <code>C:\Program Files (x86)\Microsoft SDKs</code> into the <code>SDKs</code> folder beside your solution file.</li>
<li>Add this snippet to the <code>.csproj</code> file:</li>
</ol>
<pre><code class="language-xml">&lt;PropertyGroup&gt;
  &lt;SDKReferenceDirectoryRoot&gt;$(SolutionDir)\SDKs;$(SDKReferenceDirectoryRoot)&lt;/SDKReferenceDirectoryRoot&gt;
&lt;/PropertyGroup&gt;
</code></pre>
<h3 id="versioning-the-packages">1.4 Versioning the packages</h3>
<p>Usually the version of the package is stored inside <code>Package.appxmanifest</code> and auto-incremented by Visual Studio. But this requires you to commit the changes to make sure you don't reuse versions.</p>
<p>I am not comfortable with build pipelines committing changes to source code. Fortunately there are a few extensions for Azure DevOps that can help with this. The one I decided to use is <a href="https://marketplace.visualstudio.com/items?itemName=maikvandergaag.maikvandergaag-versioncounter">Version Number counter</a>. <a href="https://msftplayground.com/2018/11/version-number-counter-for-azure-devops/">This article</a> does a great job of explaining how you can use it.</p>
<p>What we can do is have a PowerShell script  update the app manifest file:</p>
<pre><code class="language-powershell"># https://stackoverflow.com/a/42699995
$xmlFileName = &quot;$(Build.SourcesDirectory)\{ProjectName}\Package.appxmanifest&quot;
      
[xml]$xmlDoc = Get-Content $xmlFileName
$xmlDoc.Package.Identity.Version = &quot;$env:appVersion.0&quot;

echo 'New version:' $xmlDoc.Package.Identity.Version

$xmlDoc.Save($xmlFileName)
</code></pre>
<p>For that you need to define a variable called <code>appVersion</code> with the initial version in this format: <code>1.0.0</code>. Because UWP package version format is like <code>1.0.0.0</code>, you have to concatenate another &quot;0&quot; at the end of <code>appVersion</code>.</p>
<p>If you're a desktop developer, you might not like PowerShell or bash scripts. But they are very powerful and flexible for automation scenarios.</p>
<h3 id="use-templates">1.5 Use templates</h3>
<p>Sometimes you have multiple configurations and environments you want to build for. We wanted to be able to build for both Production and Staging environments. Each of which have different build configuration (Release, Debug, Staging...), supported different build platforms (x86, x64, ARM), had different auto-update URLs, etc..</p>
<p>Azure DevOps yaml files support templates. You define a base template and put all of the common steps and jobs there, then you define a bunch of parameters for the template so that the pipelines that inherit from the base template can configure these parameters.</p>
<h2 id="the-code">The code</h2>
<p><code>Template.yaml</code></p>
<pre><code class="language-yaml">parameters:
    # Platforms to generate bundles for: x86, x64, x86|x64
    buildPlatform: 'x86|x64'
    # Platforms to generate bundles for (Debug, Release...)
    buildConfiguration: 'Release'

    # Where will the installer be uploaded to?
    installerUrl: 'Replace this by the actual URL'

    # The version of the app
    appVersion: '1.1.1'

    solution: '{ProjectName}.sln'
    appxPackageDir: '$(build.artifactStagingDirectory)\AppxPackages\\'

steps:
- task: PowerShell&#64;2
  env:
    appVersion: ${{ parameters.appVersion }}
    buildPlatform: ${{ parameters.buildPlatform }}
    buildConfiguration: ${{ parameters.buildConfiguration }}
    installerUrl: ${{ parameters.installerUrl }}

  displayName: 'Print variables'
  inputs:
    targetType: 'inline'
    script: |
      echo &quot;appVersion: $env:appVersion&quot;
      echo &quot;buildPlatform: $env:buildPlatform&quot;
      echo &quot;buildConfiguration: $env:buildConfiguration&quot;
      echo &quot;installerUrl: $env:installerUrl&quot;

- task: versioncounter&#64;1
  inputs:
    VersionVariable: 'appVersion'
    UpdateMinorVersion: true
    DevOpsPat: '{Your_PAT}'

- task: PowerShell&#64;2
  env:
    appVersion: ${{ parameters.appVersion }}
  displayName: 'Replace Version Number in the manifest file'
  inputs:
    targetType: 'inline'
    script: |
      # https://stackoverflow.com/a/42699995
      $xmlFileName = &quot;$(Build.SourcesDirectory)\{ProjectName}\Package.appxmanifest&quot;
      
      [xml]$xmlDoc = Get-Content $xmlFileName
      $xmlDoc.Package.Identity.Version = &quot;$env:appVersion.0&quot;

      echo 'New version:' $xmlDoc.Package.Identity.Version

      $xmlDoc.Save($xmlFileName)

- task: NuGetToolInstaller&#64;1
  inputs:
    versionSpec: '4.9.2'

- task: NuGetCommand&#64;2
  inputs:
    command: 'restore'
    restoreSolution: '${{ parameters.solution }}'

- task: VSBuild&#64;1
  inputs:
    solution: '${{ parameters.solution }}'
    msbuildArgs: '/p:AppxBundlePlatforms=&quot;${{ parameters.buildPlatform}}&quot; /p:AppxPackageDir=&quot;${{ parameters.appxPackageDir}}&quot; /p:AppxBundle=Always /p:UapAppxPackageBuildMode=SideloadOnly'
    platform: 'x64'
    configuration: '${{ parameters.buildConfiguration }}'
    msbuildArchitecture: 'x64'

- task: PowerShell&#64;2
  env:
    installerUrl: ${{ parameters.installerUrl }}
  displayName: 'Replace installer url'
  inputs:
    targetType: 'inline'
    script: |
      # https://stackoverflow.com/a/17144445
      $fileName = &quot;$(build.artifactStagingDirectory)\AppxPackages\{ProjectName}.appinstaller&quot;
      
      $original = &quot;{Original Url in the .appinstaller file}&quot;

      $content = Get-Content $fileName
      $content = $content.replace($original, $env:installerUrl)

      Set-Content -Path $fileName -Value $content

      echo 'Install Url:' $env:installerUrl

- task: CopyFiles&#64;2
  displayName: 'Copy Files to: $(build.artifactstagingdirectory)'
  inputs:
    SourceFolder: '$(system.defaultworkingdirectory)'
    Contents: '**\bin\${{ parameters.buildConfiguration }}\**'
    TargetFolder: '$(build.artifactstagingdirectory)'

- task: PublishBuildArtifacts&#64;1
  displayName: 'Publish Artifact: drop'
  inputs:
    PathtoPublish: '$(build.artifactstagingdirectory)'

</code></pre>
<p><code>Staging.yml</code></p>
<pre><code class="language-yaml"># Staging
trigger:
 - master

pool:
  name: &quot;Default&quot;

steps:
    - template: Template.yml
      parameters:
        buildPlatform: 'x64'
        buildConfiguration: 'Release'
        installerUrl: '{Staging_URL}'
        appVersion: $(appVersion)
</code></pre>
<p><code>Production.yml</code></p>
<pre><code class="language-yml"># Production
trigger: none

pool:
  name: &quot;Default&quot;

steps:
    - template: Template.yml
      parameters:
        buildPlatform: 'x86|x64'
        buildConfiguration: 'Release'
        installerUrl: '{Production_URL}'
        appVersion: $(appVersion)
</code></pre>
<h1 id="setup-a-release-pipeline">2. Setup a release pipeline</h1>
<p>The release pipeline is very easy, since all of the hard work is done in the build pipeline. The only thing you have to do is:</p>
<ol>
<li><p>Get the build artifacts from the build pipeline. You can do that by clicking &quot;Artifacts&quot; part. Select &quot;Build&quot; from &quot;Source Type&quot; and select the appropriate build pipeline.</p>
</li>
<li><p>Upload the <code>index.html</code>, <code>{ProjectName}.appinstaller</code> and the package folder to the update website via FTP. Azure DevOps has a built-in task for FTP upload.</p>
</li>
</ol>
<h1 id="celebrate">3. Celebrate 🎉</h1>
<p>The title pretty much says it all.</p>
<hr />
<p>Update 04/25/2020:</p>
<p>You can use the <a href="https://marketplace.visualstudio.com/items?itemName=stefankert.codesigning">Code Signing Task</a> for signing your WUP app easily and securely.</p>


<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'mazeez'; // required: replace example with your forum shortname
    var disqus_identifier = 'uwp-devops';
    var disqus_title = 'Setting up automated build and release pipeline for side-loaded UWP apps using Azure DevOps';
    var disqus_url = 'https://mazeez.dev/posts/uwp-devops';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                        </div>
                </div>
        </div>

        <hr>

        <!-- Footer -->
        <footer>
                <ul class="list-inline text-center">
                        <li>
                                <a href="https://twitter.com/mhmd_azeez">
                                        <span class="fa-stack fa-lg">
                                                <i class="fa fa-circle fa-stack-2x"></i>
                                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                        </span>
                                </a>
                        </li>

                        <li>
                                <a href="https://github.com/encrypt0r">
                                        <span class="fa-stack fa-lg">
                                                <i class="fa fa-circle fa-stack-2x"></i>
                                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                        </span>
                                </a>
                        </li>

                        
                        <li>
                                <a href="mailto:muhammad-azeez@outlook.com">
                                        <span class="fa-stack fa-lg">
                                                <i class="fa fa-circle fa-stack-2x"></i>
                                                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                                        </span>
                                </a>
                        </li>

                        
                        <li>
                                <a href="https://www.linkedin.com/in/muhammad-azeez/">
                                        <span class="fa-stack fa-lg">
                                                <i class="fa fa-circle fa-stack-2x"></i>
                                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                                        </span>
                                </a>
                        </li>
                </ul>

                <div class="container">
        <div class="row">
                <div class="col-md-12 text-center">
                    <p class="copyright text-muted">
                        Copyright © 2020
                        <br />
                            <a href="/feed.rss"><i class="fa fa-rss"></i> RSS Feed</a>
                        |
                            <a href="/feed.atom"><i class="fa fa-rss"></i> Atom Feed</a>
                        <br />
                        <strong><a href="https://wyam.io">Generated by Wyam</a></strong>
                    </p>
                </div>
        </div>
</div>

        </footer>

        
        <script>
                hljs.initHighlightingOnLoad();
                hljs.configure({
                        languages: []
                });
        </script>


        <script>
                BackgroundCheck.init({
                        targets: '.intro-header,.navbar',
                        images: '.intro-header'
                });
        </script>

        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-141113720-1"></script>
        <script>
                window.dataLayer = window.dataLayer || [];

                function gtag() {
                        dataLayer.push(arguments);
                }
                gtag('js', new Date());

                gtag('config', 'UA-141113720-1');
        </script>

</body>

</html>